<div class="d-md-flex d-flex-column">
  <app-profsidebar></app-profsidebar>
  
  <div class="row w-100 m-0 mt-3">
    <div class="col p-0">
      <!-- En-tête -->
      <div class="d-flex act p-0 py-3 ps-4 align-items-center">
        <p class="p1 ps-3">Skooly / </p>
        <p>Notes</p>
      </div>

      <div class="container-fluid px-5 py-4">
        
        <!-- Filtres avec MATIÈRE -->
        <div class="row mb-4">
          <div class="col-md-3">
            <label class="form-label fw-bold">Classe</label>
            <select class="form-select" [(ngModel)]="classeId" (change)="changerClasse()">
              <option value="">Choisir une classe</option>
              <option *ngFor="let classe of classes" [value]="classe.id_classe">
                {{classe.nom_classe}} ({{classe.niveau}})
              </option>
            </select>
          </div>
          
          <div class="col-md-2">
            <label class="form-label fw-bold">Semestre</label>
            <select class="form-select" [(ngModel)]="semestre" (change)="changerSemestre()">
              <option value="S1">S1</option>
              <option value="S2">S2</option>
            </select>
          </div>
          
          <div class="col-md-3">
            <label class="form-label fw-bold">Matière <span class="text-danger">*</span></label>
            <select class="form-select" [(ngModel)]="matiereId" (change)="changerMatiere()" 
                    [disabled]="matieres.length === 0">
              <option value="">Choisir une matière</option>
              <option *ngFor="let matiere of matieres" [value]="matiere.id_matiere">
                {{matiere.nom_matiere}} (Coeff: {{matiere.coefficient}})
              </option>
            </select>
          </div>
          
          <div class="col-md-4 d-flex align-items-end justify-content-end gap-2">
            <button class="btn btn-outline-secondary" (click)="chargerNotes()" [disabled]="loading">
              <i class="bi bi-arrow-clockwise"></i> Actualiser
            </button>
            <button class="btn btn-success" (click)="sauvegarderNotes()" 
                    [disabled]="saving || notes.length === 0 || loading">
              <i class="bi bi-save"></i>
              {{saving ? 'Sauvegarde...' : 'Sauvegarder'}}
            </button>
          </div>
        </div>

        <!-- Card titre matière actuelle -->
        <div class="card mb-4" *ngIf="matiereId">
          <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <h5 class="mb-0">{{getNomMatiereActuelle()}}</h5>
                <small>{{getNomClasseActuelle()}}</small>
              </div>
              <small>DS (30%) + Examen (70%)</small>
            </div>
          </div>
        </div>
        <!-- Loading -->
        <div *ngIf="loading" class="text-center py-5">
          <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
          <p class="mt-3 text-muted">Chargement des notes...</p>
        </div>

        <!-- Tableau saisie (UN SEUL) -->
        <div class="card" *ngIf="!loading && notes.length > 0">
          <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 600px;">
              <table class="table table-hover mb-0">
                <thead class="table-light sticky-top">
                  <tr>
                    <th width="25%">Étudiant</th>
                    <th width="25%">Matière (Coeff)</th>
                    <th width="15%">DS (30%)</th>
                    <th width="15%">Examen (70%)</th>
                    <th width="20%">Moyenne</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let note of notes">
                    <td>
                      <strong>{{note.prenom}} {{note.nom}}</strong>
                    </td>
                    <td>
                      <strong>{{note.nom_matiere}}</strong>
                      <span class="badge bg-secondary ms-1">{{note.coefficient}}</span>
                    </td>
                    <td>
                      <input type="number" 
                             class="form-control form-control-sm"
                             min="0" max="20"
                             [(ngModel)]="note.note_ds"
                             placeholder="0.0">
                    </td>
                    <td>
                      <input type="number" 
                             class="form-control form-control-sm"
                             min="0" max="20"
                             [(ngModel)]="note.note_examen"
                             placeholder="0.0">
                    </td>
                    <td class="fw-bold align-middle">
                      <span [ngClass]="{
                        'text-success': calculerMoyenne(note) >= 10,
                        'text-warning': calculerMoyenne(note) >= 8 && calculerMoyenne(note) < 10,
                        'text-danger': calculerMoyenne(note) < 8
                      }">
                        {{calculerMoyenne(note) | number:'1.2-2'}}
                      </span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="card-footer bg-light">
            <div class="d-flex justify-content-between">
              <small>Total: {{notes.length}} étudiants</small>
              <button class="btn btn-success btn-sm" (click)="sauvegarderNotes()" [disabled]="saving">
                <i class="bi bi-save"></i> Sauvegarder toutes les notes
              </button>
            </div>
          </div>
        </div>

        <!-- Vide -->
        <div *ngIf="!loading && notes.length === 0 && matiereId" class="text-center py-5 text-muted">
          <i class="bi bi-clipboard-x fs-1 mb-3"></i>
          <h5>Aucune donnée disponible</h5>
          <p>Vérifiez les filtres ou ajoutez des étudiants à cette classe.</p>
        </div>

        <!-- Info filtres vides -->
        <div *ngIf="!loading && (!classeId || !matiereId)" class="text-center py-5 text-muted">
          <i class="bi bi-info-circle fs-1 mb-3"></i>
          <h5>Sélectionnez une classe et une matière</h5>
          <p>Choisissez d'abord une classe, puis un semestre, et enfin une matière.</p>
        </div>
      </div>
    </div>
  </div>
</div>
