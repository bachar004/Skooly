<div class="d-md-flex d-flex-column">
    <app-profsidebar></app-profsidebar>
    <div class="row w-100 m-0 mt-3">
        <div class="col p-0">
            <div class="d-flex act p-0 py-3 ps-4 align-items-center">
                <p class="p1 ps-3">Skooly / </p>
                <p>Acceuil</p>
            </div>
            <div class="container-fluid px-5 py-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 class="text-primary mb-0">
                        <i class="bi bi-calendar3 me-2"></i>
                        Mon Emploi du Temps
                    </h3>
                    
                    <!-- Boutons de vue -->
                    <div class="btn-group" role="group">
                        <button 
                            class="btn" 
                            [class.btn-primary]="vueActive === 'semaine'"
                            [class.btn-outline-primary]="vueActive !== 'semaine'"
                            (click)="changerVue('semaine')">
                            <i class="bi bi-calendar-week me-1"></i>
                            Semaine
                        </button>
                        <button 
                            class="btn"
                            [class.btn-primary]="vueActive === 'jour'"
                            [class.btn-outline-primary]="vueActive !== 'jour'"
                            (click)="changerVue('jour')">
                            <i class="bi bi-calendar-day me-1"></i>
                            Jour
                        </button>
                        <button 
                            class="btn"
                            [class.btn-primary]="vueActive === 'classes'"
                            [class.btn-outline-primary]="vueActive !== 'classes'"
                            (click)="changerVue('classes')">
                            <i class="bi bi-people me-1"></i>
                            Classes
                        </button>
                    </div>
                </div>

                <!-- Message d'erreur -->
                <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    {{ errorMessage }}
                    <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
                </div>

                <!-- Message de succès -->
                <div *ngIf="messageSucces" class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    {{ messageSucces }}
                    <button type="button" class="btn-close" (click)="messageSucces = ''" aria-label="Close"></button>
                </div>

                <!-- Loading spinner -->
                <div *ngIf="isLoading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                        <span class="visually-hidden">Chargement...</span>
                    </div>
                    <p class="mt-3 text-muted">Chargement de l'emploi du temps...</p>
                </div>

                <!-- Contenu principal -->
                <div *ngIf="!isLoading">
                    <!-- Statistiques -->
                    <div class="row mb-4">
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card stat-card border-0 shadow-sm bg-primary text-white h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-book-half fs-1 mb-2 opacity-75"></i>
                                    <h3 class="fw-bold mb-0">{{ getTotalSeances() }}</h3>
                                    <small class="opacity-75">Séances/semaine</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card stat-card border-0 shadow-sm bg-success text-white h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-people-fill fs-1 mb-2 opacity-75"></i>
                                    <h3 class="fw-bold mb-0">{{ classes.length }}</h3>
                                    <small class="opacity-75">Classes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card stat-card border-0 shadow-sm bg-info text-white h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-journals fs-1 mb-2 opacity-75"></i>
                                    <h3 class="fw-bold mb-0">{{ matieres.length }}</h3>
                                    <small class="opacity-75">Matières</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <div class="card stat-card border-0 shadow-sm bg-warning text-white h-100">
                                <div class="card-body text-center">
                                    <i class="bi bi-calendar-check fs-1 mb-2 opacity-75"></i>
                                    <h3 class="fw-bold mb-0">{{ getStatistiques().jours_travailles }}</h3>
                                    <small class="opacity-75">Jours de cours</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VUE SEMAINE -->
                    <div *ngIf="vueActive === 'semaine'" class="row">
                        <div class="col-12">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">
                                        <i class="bi bi-calendar-week me-2"></i>
                                        Emploi du temps de la semaine
                                    </h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-bordered mb-0 emploi-table">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th style="width: 14%;" 
                                                        *ngFor="let jour of jours"
                                                        [class.bg-success]="estJourActuel(jour)">
                                                        {{ jour }}
                                                        <span *ngIf="estJourActuel(jour)" class="badge bg-light text-dark ms-1">
                                                            Aujourd'hui
                                                        </span>
                                                        <br>
                                                        <small class="opacity-75">{{ getSeancesParJour(jour) }} séance(s)</small>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td *ngFor="let jour of jours" class="align-top p-2">
                                                        <div *ngIf="!aDesSeances(jour)" class="text-center text-muted py-5">
                                                            <i class="bi bi-calendar-x fs-3"></i>
                                                            <p class="mb-0 mt-2 small">Pas de cours</p>
                                                        </div>
                                                        
                                                        <div 
                                                            *ngFor="let seance of emploiParJour[jour]" 
                                                            class="seance-card mb-2 p-2 rounded position-relative"
                                                            [style.border-left]="'4px solid ' + getCouleurMatiere(seance.id_matiere)"
                                                            style="background-color: #f8f9fa;">
                                                            <div class="d-flex justify-content-between align-items-start">
                                                                <div class="flex-grow-1">
                                                                    <div class="fw-bold text-primary small">
                                                                        {{ formatHeure(seance.heure_debut) }} - {{ formatHeure(seance.heure_fin) }}
                                                                    </div>
                                                                    <div class="fw-bold mt-1">
                                                                        {{ seance.nom_matiere }}
                                                                    </div>
                                                                    <div class="small text-muted">
                                                                        <i class="bi bi-people me-1"></i>
                                                                        {{ seance.nom_classe }}
                                                                    </div>
                                                                    <div class="small text-muted">
                                                                        <i class="bi bi-door-closed me-1"></i>
                                                                        Salle {{ seance.salle }}
                                                                    </div>
                                                                    <button 
                                                                        class="btn btn-sm btn-success mt-2 w-100"
                                                                        (click)="ouvrirAppel(seance)">
                                                                        <i class="bi bi-clipboard-check me-1"></i>
                                                                        Faire l'appel
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VUE JOUR -->
                    <div *ngIf="vueActive === 'jour'">
                        <!-- Sélecteur de jour -->
                        <div class="card mb-4 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title mb-3">Sélectionner un jour :</h5>
                                <div class="btn-group w-100 flex-wrap" role="group">
                                    <button 
                                        *ngFor="let jour of jours"
                                        class="btn"
                                        [class.btn-primary]="jourSelectionne === jour"
                                        [class.btn-outline-primary]="jourSelectionne !== jour"
                                        [class.active-day]="estJourActuel(jour)"
                                        (click)="selectionnerJour(jour)">
                                        {{ jour }}
                                        <span *ngIf="estJourActuel(jour)" class="d-block small">
                                            <i class="bi bi-circle-fill text-success" style="font-size: 8px;"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Séances du jour -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-day me-2"></i>
                                    {{ jourSelectionne || 'Sélectionnez un jour' }} - {{ getSeancesDuJour().length }} séance(s)
                                </h5>
                            </div>
                            <div class="card-body">
                                <div *ngIf="getSeancesDuJour().length === 0" class="text-center py-5">
                                    <i class="bi bi-calendar-x text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="mt-3 text-muted">Pas de cours ce jour</h4>
                                    <p class="text-muted">Aucune séance programmée pour {{ jourSelectionne }}</p>
                                </div>

                                <div class="timeline">
                                    <div 
                                        *ngFor="let seance of getSeancesDuJour(); let i = index" 
                                        class="timeline-item mb-4">
                                        <div class="row">
                                            <div class="col-md-2 text-end">
                                                <div class="fw-bold text-primary">
                                                    {{ formatHeure(seance.heure_debut) }}
                                                </div>
                                                <small class="text-muted">à</small>
                                                <div class="fw-bold text-primary">
                                                    {{ formatHeure(seance.heure_fin) }}
                                                </div>
                                            </div>
                                            <div class="col-md-10">
                                                <div 
                                                    class="card border-start border-4 shadow-sm"
                                                    [style.border-left-color]="getCouleurMatiere(seance.id_matiere) + ' !important'">
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-8">
                                                                <h5 class="card-title mb-2">
                                                                    <i class="bi bi-book me-2"></i>
                                                                    {{ seance.nom_matiere }}
                                                                </h5>
                                                                <p class="card-text mb-2">
                                                                    <i class="bi bi-people me-2 text-primary"></i>
                                                                    <strong>Classe :</strong> {{ seance.nom_classe }} ({{ seance.niveau }})
                                                                </p>
                                                                <p class="card-text mb-0">
                                                                    <i class="bi bi-door-closed me-2 text-warning"></i>
                                                                    <strong>Salle :</strong> {{ seance.salle }}
                                                                </p>
                                                            </div>
                                                            <div class="col-md-4 text-end">
                                                                <button 
                                                                    class="btn btn-success w-100"
                                                                    (click)="ouvrirAppel(seance)">
                                                                    <i class="bi bi-clipboard-check me-1"></i>
                                                                    Faire l'appel
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VUE CLASSES -->
                    <div *ngIf="vueActive === 'classes'">
                        <div class="card shadow-sm">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="bi bi-people me-2"></i>
                                    Mes Classes ({{ classes.length }})
                                </h5>
                            </div>
                            <div class="card-body">
                                <div *ngIf="classes.length === 0" class="text-center py-5">
                                    <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="mt-3 text-muted">Aucune classe</h4>
                                    <p class="text-muted">Vous n'avez pas encore de classes assignées</p>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 col-lg-4 mb-3" *ngFor="let classe of classes">
                                        <div class="card h-100 border-0 shadow-sm classe-card">
                                            <div class="card-body">
                                                <div class="d-flex justify-content-between align-items-start mb-3">
                                                    <h5 class="card-title mb-0">
                                                        <i class="bi bi-mortarboard-fill text-success me-2"></i>
                                                        {{ classe.nom_classe }}
                                                    </h5>
                                                    <span class="badge bg-success">{{ classe.niveau }}</span>
                                                </div>
                                                <hr>
                                                <div class="mb-2">
                                                    <i class="bi bi-calendar-week text-muted me-2"></i>
                                                    <strong>{{ classe.nombre_seances }}</strong> séances/semaine
                                                </div>
                                                <div class="mb-3">
                                                    <i class="bi bi-people text-muted me-2"></i>
                                                    <strong>{{ classe.nombre_etudiants }}</strong> étudiants
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Appel -->
<div class="modal fade" id="appelModal" tabindex="-1" [class.show]="showAppelModal" [style.display]="showAppelModal ? 'block' : 'none'">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Feuille d'appel
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="fermerAppel()"></button>
            </div>
            <div class="modal-body">
                <div *ngIf="seanceSelectionnee">
                    <!-- Informations de la séance -->
                    <div class="card mb-3 border-primary">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <strong><i class="bi bi-book me-2 text-primary"></i>Matière :</strong>
                                    <span class="ms-2">{{ seanceSelectionnee.nom_matiere }}</span>
                                </div>
                                <div class="col-md-4">
                                    <strong><i class="bi bi-people me-2 text-success"></i>Classe :</strong>
                                    <span class="ms-2">{{ seanceSelectionnee.nom_classe }}</span>
                                </div>
                                <div class="col-md-4">
                                    <strong><i class="bi bi-clock me-2 text-warning"></i>Horaire :</strong>
                                    <span class="ms-2">{{ formatHeure(seanceSelectionnee.heure_debut) }} - {{ formatHeure(seanceSelectionnee.heure_fin) }}</span>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-4">
                                    <strong><i class="bi bi-calendar me-2 text-info"></i>Date :</strong>
                                    <input 
                                        type="date" 
                                        class="form-control form-control-sm d-inline-block w-auto ms-2"
                                        [(ngModel)]="dateAppel"
                                        (change)="chargerListeAppel()">
                                </div>
                                <div class="col-md-4">
                                    <strong><i class="bi bi-door-closed me-2 text-secondary"></i>Salle :</strong>
                                    <span class="ms-2">{{ seanceSelectionnee.salle }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistiques rapides -->
                    <div class="row mb-3">
                        <div class="col-3">
                            <div class="card text-center border-success">
                                <div class="card-body py-2">
                                    <h4 class="text-success mb-0">{{ statsAppel.presents }}</h4>
                                    <small class="text-muted">Présents</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card text-center border-danger">
                                <div class="card-body py-2">
                                    <h4 class="text-danger mb-0">{{ statsAppel.absents }}</h4>
                                    <small class="text-muted">Absents</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card text-center border-warning">
                                <div class="card-body py-2">
                                    <h4 class="text-warning mb-0">{{ statsAppel.retards }}</h4>
                                    <small class="text-muted">Retards</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-3">
                            <div class="card text-center border-info">
                                <div class="card-body py-2">
                                    <h4 class="text-info mb-0">{{ statsAppel.justifies }}</h4>
                                    <small class="text-muted">Justifiés</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions rapides -->
                    <div class="mb-3 d-flex align-items-center">
                        <button class="btn btn-sm btn-success me-2" (click)="marquerTousPresents()">
                            <i class="bi bi-check-all me-1"></i>
                            Tous présents
                        </button>
                        <span *ngIf="dejaSaisi" class="badge bg-warning text-dark">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Appel déjà enregistré pour cette date
                        </span>
                    </div>

                    <!-- Liste des étudiants -->
                    <div *ngIf="loadingAppel" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Chargement...</span>
                        </div>
                        <p class="mt-2 text-muted">Chargement de la liste...</p>
                    </div>

                    <div *ngIf="!loadingAppel && etudiantsAppel.length > 0">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 5%;">#</th>
                                        <th style="width: 20%;">Nom</th>
                                        <th style="width: 20%;">Prénom</th>
                                        <th style="width: 25%;">Statut</th>
                                        <th style="width: 30%;">Remarque</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let etudiant of etudiantsAppel; let i = index"
                                        [class.table-success]="etudiant.statut === 'present'"
                                        [class.table-danger]="etudiant.statut === 'absent'"
                                        [class.table-warning]="etudiant.statut === 'retard'"
                                        [class.table-info]="etudiant.statut === 'justifie'">
                                        <td>{{ i + 1 }}</td>
                                        <td class="fw-bold">{{ etudiant.nom }}</td>
                                        <td>{{ etudiant.prenom }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button 
                                                    type="button"
                                                    class="btn"
                                                    [class.btn-success]="etudiant.statut === 'present'"
                                                    [class.btn-outline-success]="etudiant.statut !== 'present'"
                                                    (click)="changerStatut(etudiant, 'present')"
                                                    title="Présent">
                                                    <i class="bi bi-check-lg"></i>
                                                </button>
                                                <button 
                                                    type="button"
                                                    class="btn"
                                                    [class.btn-danger]="etudiant.statut === 'absent'"
                                                    [class.btn-outline-danger]="etudiant.statut !== 'absent'"
                                                    (click)="changerStatut(etudiant, 'absent')"
                                                    title="Absent">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                                <button 
                                                    type="button"
                                                    class="btn"
                                                    [class.btn-warning]="etudiant.statut === 'retard'"
                                                    [class.btn-outline-warning]="etudiant.statut !== 'retard'"
                                                    (click)="changerStatut(etudiant, 'retard')"
                                                    title="Retard">
                                                    <i class="bi bi-clock"></i>
                                                </button>
                                                <button 
                                                    type="button"
                                                    class="btn"
                                                    [class.btn-info]="etudiant.statut === 'justifie'"
                                                    [class.btn-outline-info]="etudiant.statut !== 'justifie'"
                                                    (click)="changerStatut(etudiant, 'justifie')"
                                                    title="Justifié">
                                                    <i class="bi bi-file-earmark-text"></i>
                                                </button>
                                            </div>
                                        </td>
                                        <td>
                                            <input 
                                                type="text" 
                                                class="form-control form-control-sm"
                                                [(ngModel)]="etudiant.remarque"
                                                placeholder="Remarque...">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div *ngIf="!loadingAppel && etudiantsAppel.length === 0" class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Aucun étudiant trouvé pour cette séance.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="fermerAppel()">
                    <i class="bi bi-x-circle me-1"></i>
                    Annuler
                </button>
                <button 
                    type="button" 
                    class="btn btn-primary"
                    [disabled]="loadingAppel || savingAppel || etudiantsAppel.length === 0"
                    (click)="sauvegarderAppel()">
                    <span *ngIf="savingAppel" class="spinner-border spinner-border-sm me-1"></span>
                    <i *ngIf="!savingAppel" class="bi bi-save me-1"></i>
                    {{ savingAppel ? 'Enregistrement...' : 'Sauvegarder' }}
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade" *ngIf="showAppelModal" [class.show]="showAppelModal"></div>